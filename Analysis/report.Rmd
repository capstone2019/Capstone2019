---
title: "Analyzing HCA Claims"
author: "Yasmine, Anni, Vanessa, Katie"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(ggplot2)
library(knitr)
library(plotly)

med <- read.csv('../../data/claims_med_interns_2016-2018_20190228.csv', stringsAsFactors = F)
#pharm <- read.csv('../../data/claims_pharm_capstone_2016-2018.csv', stringsAsFactors = F)

#med data analysis
med_revise <- med %>% select("Member.ID.Encrypted", "Claim.ID","Member.Gender",
                             "Age", 17:46, 
                      "Incurred.Year", "Zip..5.digit.") %>% 
  filter(med$Zip..5.digit. < 99403 & med$Zip..5.digit. > 98000)

# get data of chronic diseases
source('get_chronic.R')
```

## 1. What are the most common chronic diseases?

### 1.1 Chronic Diseases of Interest

Our goal is to understand the prevalance and determinants of chronic diseases in Washington State. To do this, we want to first get an understanding of the occurrence of these diseases in the claims data.

The relevant chronic conditions (and their respective ICD-10 codes) we will focus on include:

- Diabetes (excluding gestational diabetes, which has a different ICD-10 code than diabetes mellitus)
- Hypertension (I10)
- Obesity (E66)
- Cancer
- Musculoskeletal conditions (M00-M99)
- Cardiovascular conditions
- Asthma and chronic obstructive pulmonary disorder (COPD)
- Cholesterol (E78)
- Sleep disorders (insomnia ICD-10 is G47)


``` {r echo=FALSE}
chronic <- all %>% 
  group_by(label) %>% 
  distinct(Member.ID.Encrypted) %>% 
  summarize(count=n()) %>% 
  arrange(desc(count))

ggplot(data=chronic, aes(x=reorder(label, count), y=count)) +
  geom_bar(position="dodge",stat="identity", fill = 'red') + 
  coord_flip() +
  labs(title = "Occurrences of Chronic Disease", x = "Chronic Disease")

```

We can observe from this visual that **Cardiovascular** is the most occurring chronic disease by claims, whereas the least occurring disease is **Pain**. We will look into what pain really means in terms of chronic conditions.

*Limitations*

One limitation we observe is the involvement of filtering to distint member ID. We want to do this to avoid accounting for recurring claims for the same ICD for that member, as that may skew the data towards the chronic condition they have. However, having this become distinct leaves out claims a member would file for different reasons. *We need to address this*.

Another limitation is not including the other ICD Rollup codes provided apart from Primary.ICD.Rollup. We also see that if there is no other Rollup involved in that claim, the same Rollup label is sometimes used for X2nd.ICD.Rollup, X3rd, and X4th. We need to account for this so we do not have the same single ICD Rollup code accounted for 4 times for the claim. We plan to address this by

1. Create a column with a list of all ICD Rollups (Primary, X2nd, X3rd, X4th)
2. Narrow lists down to only include *unique* ICD Rollups

Once this is done, we will address the first limitation mentioned above.



### 1.2 What's up with Cardiovascular?
``` {r echo=FALSE}
cardio_type <- cardiovascular %>% 
  group_by(Primary.ICD.Diagnosis.Desc) %>% 
  distinct(Member.ID.Encrypted) %>% 
  summarise(count = n()) %>%
  arrange(-count)
```

Cardiovascular includes claims with the Primary ICD Rollup of *"Diseases of the Heart."* Cardiovascular has **`r nrow(cardio_type)`** ICD codes involved, which could attest to its volume shown in the visual above. Let's break it down to see what's really going on!

####Cardiovascular top 10 ICD codes
``` {r echo=FALSE}

ggplot(data=cardio_type[1:10,], aes(x=reorder(Primary.ICD.Diagnosis.Desc, count), y=count)) +
  geom_bar(position="dodge",stat="identity", fill = 'blue') + 
  coord_flip() +
  labs(title = "Most Common Cardiovascular Types", x = "ICD Desc")
```




### 1.3 Diving into Cancer

We observe that cancer can be broken down into many different types, and this can be important to address. Now let's look into the occurrences of types of cancer we see in our HCA population.

``` {r echo=FALSE}
cancer_type <- cancer %>% 
  group_by(Primary.ICD.Rollup) %>% 
  distinct(Member.ID.Encrypted) %>% 
  summarise(count = n())

ggplot(data=cancer_type, aes(x=reorder(Primary.ICD.Rollup, count), y=count)) +
  geom_bar(position="dodge",stat="identity", fill = 'pink') + 
  coord_flip() +
  labs(title = "Occurrences of Cancer", x = "Type of Cancer")
```

**Breast cancer** appears to be our most occurring cancer in the HCA population, while **Cancer of male genital organs** appears to be the least occurring. We can perhaps attest this to the gender distribution of our HCA population. Because we have *significantly less males than females*, we are bound to see less occurrence of a cancer associated with males and more associated with women. We can see the gender distribution of our HCA population who have filed at least one claim below.

``` {r echo=FALSE}
gender_df <- med_revise %>% select(Member.ID.Encrypted, Member.Gender) %>%
  distinct(Member.ID.Encrypted, .keep_all = TRUE)

female <- gender_df %>% filter(Member.Gender == 'F')

ggplot(gender_df) + 
  geom_bar(aes(x=Member.Gender, color=Member.Gender, fill = Member.Gender)) +
  labs(title = "Gender Distribution of HCA Population", x = "Gender", y = "Count") +
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)))

```

Of the HCA population that filed claims (*`r nrow(gender_df)`* members), **`r round(nrow(female)/nrow(gender_df), 2) * 100`%** are female and only **`r round((nrow(gender_df) - nrow(female)) / nrow(gender_df), 2) * 100`%** are male.

Now let's look into the ICD codes to understand what kind of diagnosis are the most common ones for breast cancer,  uterus cervix cancer and other primary cancer.


####Top 10 ICD codes for breast cancer
``` {r echo=FALSE}
breast_cancer <- cancer %>% 
  filter(Primary.ICD.Rollup == "Cancer of breast") %>% 
  group_by(Primary.ICD.Diagnosis.Desc) %>% 
  distinct(Member.ID.Encrypted) %>% 
  summarise(count = n()) %>%
  arrange(-count)

ggplot(data=breast_cancer[1:10,], aes(x=reorder(Primary.ICD.Diagnosis.Desc, count), y=count)) +
  geom_bar(position="dodge",stat="identity", fill = 'pink') + 
  coord_flip() +
  labs(title = "Occurrences of Breast Cancer", x = "ICD Desc")
```
We actually have **`r nrow(breast_cancer)`** ICD codes!



####Top 12 ICD codes for uterus and cervix cancer
``` {r echo=FALSE}
uterus_cervix_cancer <- cancer %>% 
  filter(Primary.ICD.Rollup == "Cancer of uterus and cervix") %>% 
  group_by(Primary.ICD.Diagnosis.Desc) %>% 
  distinct(Member.ID.Encrypted) %>% 
  summarise(count = n()) %>%
  arrange(-count)

ggplot(data=uterus_cervix_cancer[1:12,], aes(x=reorder(Primary.ICD.Diagnosis.Desc, count), y=count)) +
  geom_bar(position="dodge",stat="identity", fill = 'pink') + 
  coord_flip() +
  labs(title = "Occurrences of Cancer of uterus and cervix", x = "ICD Desc")
```


####Top 10 ICD codes for other primary cancer
The graph below shows the top 10 ICD codes for other primary cancers are neoplasm(abnormal and excessive growth of tissue) in facial glands and organs.

``` {r echo=FALSE}
other_cancer <- cancer %>% 
  filter(Primary.ICD.Rollup == "Cancer; other primary") %>% 
  group_by(Primary.ICD.Diagnosis.Desc) %>% 
  distinct(Member.ID.Encrypted) %>% 
  summarise(count = n()) %>%
  arrange(-count)

ggplot(data=other_cancer[1:10,], aes(x=reorder(Primary.ICD.Diagnosis.Desc, count), y=count)) +
  geom_bar(position="dodge",stat="identity", fill = 'pink') + 
  coord_flip() +
  labs(title = "Occurrences of Cancer of other primary", x = "ICD Desc")
```
We actually have **`r nrow(other_cancer)`** ICD codes!



### 1.4 What's up with Diabetes?

Diabetes includes claims with the Primary ICD Rollup of *"Diabetes mellitus with/without complications."* Diabetes has a lot of ICD codes involved, which could attest to its volume shown in the visual above. Let's break it down to see what's really going on!
####Diabetes top 10 ICD codes
``` {r echo=FALSE}
diabetes_type <- diabetes %>% 
  group_by(Primary.ICD.Diagnosis.Desc) %>% 
  distinct(Member.ID.Encrypted) %>% 
  summarise(count = n()) %>%
  arrange(-count)

ggplot(data=diabetes_type[1:10,], aes(x=reorder(Primary.ICD.Diagnosis.Desc, count), y=count)) +
  geom_bar(position="dodge",stat="identity", fill = 'blue') + 
  coord_flip() +
  labs(title = "Most Common diabetes Types", x = "ICD Desc")
```

We actually have **`r nrow(diabetes_type)`** ICD codes falling under diabetes condition!

### 1.5 Now let's look at Hypertension?

``` {r echo=F}
hypertension_type <- hypertension %>% 
  group_by(Primary.ICD.Diagnosis.Desc) %>% 
  distinct(Member.ID.Encrypted) %>% 
  summarise(count = n()) %>%
  select(Primary.ICD.Diagnosis.Desc)
```

Hypertension includes claims with the Primary ICD Rollup of *"Hypertension"* It has only one ICD codes involved: `hypertension_type`.

### 1.6 Now let's look at Musculoskeletal conditions?

Musculoskeletal conditions includes claims with the Primary ICD Rollup of *"Other bone disease and musculoskeletal deformities"* It has a lot of ICD codes involved, which could attest to its volume shown in the visual above. Let's break it down to see what's really going on!

####Musculoskeletal top 10 ICD codes
``` {r echo=FALSE}
musculoskeletal_type <- musculoskeletal %>% 
  group_by(Primary.ICD.Diagnosis.Desc) %>% 
  distinct(Member.ID.Encrypted) %>% 
  summarise(count = n()) %>%
  arrange(-count)

ggplot(data=musculoskeletal_type[1:10,], aes(x=reorder(Primary.ICD.Diagnosis.Desc, count), y=count)) +
  geom_bar(position="dodge",stat="identity", fill = 'blue') + 
  coord_flip() +
  labs(title = "Most Common musculoskeletal Types", x = "ICD Desc")
```

We actually have **`r nrow(musculoskeletal_type)`** ICD codes falling under musculoskeletal condition!

### 1.7 Now let's look at obesity?

Obesity includes claims with the Primary ICD Rollup of *"Other nutritional; endocrine; and metabolic disorders"* It has 6 ICD codes involved, which could attest to its volume shown in the visual above. Let's break it down to see what's really going on!

####Obesity top 6 ICD codes
``` {r echo=FALSE}
obesity_type <- obesity %>% 
  group_by(Primary.ICD.Diagnosis.Desc) %>% 
  distinct(Member.ID.Encrypted) %>% 
  summarise(count = n()) %>%
  arrange(-count)

ggplot(data=obesity_type[1:6,], aes(x=reorder(Primary.ICD.Diagnosis.Desc, count), y=count)) +
  geom_bar(position="dodge",stat="identity", fill = 'white') + 
  coord_flip() +
  labs(title = "Most Common obesity Types", x = "ICD Desc")
```


### 1.8 Now let's look at asthma conditions?

Asthma conditions includes claims with the Primary ICD Rollup of *"Asthma"* It has 10 ICD codes involved, which could attest to its volume shown in the visual above. Let's break it down to see what's really going on!

####Asthma top 10 ICD codes
``` {r echo=FALSE}
asthma_type <- asthma %>% 
  group_by(Primary.ICD.Diagnosis.Desc) %>% 
  distinct(Member.ID.Encrypted) %>% 
  summarise(count = n()) %>%
  arrange(-count)

ggplot(data=asthma_type[1:10,], aes(x=reorder(Primary.ICD.Diagnosis.Desc, count), y=count)) +
  geom_bar(position="dodge",stat="identity", fill = 'white') + 
  coord_flip() +
  labs(title = "Most Common asthma Types", x = "ICD Desc")
```


### 1.9 Now let's look at COPD conditions?

COPD(chronic obstructive pulmonary disorder) conditions includes claims with the Primary ICD Rollup of *"Chronic obstructive pulmonary disease and bronchiectasis"* It has 11 ICD codes involved, which could attest to its volume shown in the visual above. Let's break it down to see what's really going on!

####COPD top 11 ICD codes
``` {r echo=FALSE}
copd_type <- copd %>% 
  group_by(Primary.ICD.Diagnosis.Desc) %>% 
  distinct(Member.ID.Encrypted) %>% 
  summarise(count = n()) %>%
  arrange(-count)

ggplot(data=copd_type[1:10,], aes(x=reorder(Primary.ICD.Diagnosis.Desc, count), y=count)) +
  geom_bar(position="dodge",stat="identity", fill = 'white') + 
  coord_flip() +
  labs(title = "Most Common copd Types", x = "ICD Desc")
```


### 1.9.1 Now let's look at cholesterol conditions?

Cholesterol conditions includes claims with the Primary ICD Rollup of *"Disorders of lipid metabolism"* It has 9 ICD codes involved, which could attest to its volume shown in the visual above. Let's break it down to see what's really going on!

####Cholesterol top 9 ICD codes
``` {r echo=FALSE}
cholesterol_type <- cholesterol %>% 
  group_by(Primary.ICD.Diagnosis.Desc) %>% 
  distinct(Member.ID.Encrypted) %>% 
  summarise(count = n()) %>%
  arrange(-count)

ggplot(data=cholesterol_type[1:9,], aes(x=reorder(Primary.ICD.Diagnosis.Desc, count), y=count)) +
  geom_bar(position="dodge",stat="identity", fill = 'purple') + 
  coord_flip() +
  labs(title = "Most Common cholesterol Types", x = "ICD Desc")
```


### 1.9.2 Now let's look at sleep disorder?

Sleep_disorders includes claims with the Primary ICD Rollup of *"Unknown"* It has a lot of ICD codes involved, which could attest to its volume shown in the visual above. Let's break it down to see what's really going on!

####Sleep disorder top 10 ICD codes
``` {r echo=FALSE}
sleep_type <- sleep_disorders %>% 
  group_by(Primary.ICD.Diagnosis.Desc) %>% 
  distinct(Member.ID.Encrypted) %>% 
  summarise(count = n()) %>%
  arrange(-count)

ggplot(data=sleep_type[1:10,], aes(x=reorder(Primary.ICD.Diagnosis.Desc, count), y=count)) +
  geom_bar(position="dodge",stat="identity", fill = 'purple') + 
  coord_flip() +
  labs(title = "Most Common sleep disorder Types", x = "ICD Desc")
```

We actually have **`r nrow(sleep_type)`** ICD codes!

####Next Step
So far, we have been able to break down the primary ICD rollups to correlated ICD codes and descriptions for each interested chronic condition. For the next step, we will sort all the ICD roll-ups(primary to 10th) for each member and analyze the chronic condition overall.


## 2. What is the age distribution for chronic disease?

### 2.1 Let's take a look at Diabetes

Diabetes can be broken down into two different ICD Rollups; **Diabetes mellitus with complications** and **Diabetes mellitus without complications**.

```{r echo=FALSE} 
age_dist <- med_revise %>% 
  group_by(Age) %>% 
  summarise(count = n())

diabetes_age <- diabetes %>% 
  group_by(Age, Primary.ICD.Rollup) %>% 
  distinct(Member.ID.Encrypted) %>% 
  summarise(count = n())

diabetes_age_percentage <- left_join(diabetes_age, age_dist, by= "Age") %>% mutate(percentage = count.x/count.y)

ggplot(diabetes_age_percentage) + 
  geom_bar(aes(x=Age, y=percentage, fill=Primary.ICD.Rollup), position="stack", stat="identity") +
  labs(
    title="Diabetes by Age",
    x="Age",
    y="Percentage"
  )
```

From the graph above, we can see that both ICD Rollups have similar distributions, with diabetes occuring more often in the older HCA population (~60 years old). However, we have to keep in mind that this distribution is very similar to the overall HCA age distribution.

Next steps: We hope to look into the distributions by different types of diabetes (i.e. Type 1, Type 2). In addition, we will look into the correlation between diabetes and other chronic diseases/factors influencing health of interest.

### 2.2 What about Hypertension?

Hyptension, otherwise known as High Blood Pressure, is a common condition among U.S. adults. Let's look into the age distribution for Hypertension!

```{r echo=FALSE} 
hypertension_age <- hypertension %>% 
  group_by(Age) %>% 
  distinct(Member.ID.Encrypted) %>% 
  summarise(count = n())

hypertension_age_percentage <- left_join(hypertension_age, age_dist, by= "Age") %>% mutate(percentage = count.x/count.y)

ggplot(hypertension_age_percentage) + 
  geom_bar(aes(x=Age, y=percentage), stat="identity", fill="pink") +
  labs(
    title="Hypertension by Age",
    x="Age",
    y="Percentage"
  )
```

As we can see from the graph above, the distribution for Hypertension is similar to the distribution for Diabetes, but we still have to keep in mind the distribution of our overall HCA population. 

Next steps: We want to look into the correlations between Hypertension and different chronic diseases/factors influencing health. Hypertension increases risk for other diseases and many factors such as diet can contribute to Hypertension, so this would be an interesting area to explore.

### 2.3 What can we see with Cancer?

As we saw earlier, there are many different types of cancer. Let's take a look at the top five types of cancer the HCA population have been diagnosed with.

```{r echo=FALSE} 
top_5_cancer <- cancer_type %>% arrange(desc(count))
top_5_cancer <- top_5_cancer[1:5,]

cancer_age <- cancer %>% 
  group_by(Age, Primary.ICD.Rollup) %>% 
  distinct(Member.ID.Encrypted, Primary.ICD.Rollup) %>% 
  summarise(count = n()) %>% 
  filter(Primary.ICD.Rollup %in% top_5_cancer$Primary.ICD.Rollup)

cancer_age_percentage <- left_join(cancer_age, age_dist, by= "Age") %>% mutate(percentage = count.x/count.y)

ggplot(cancer_age_percentage) + 
  geom_bar(aes(x=Age, y=percentage, fill=Primary.ICD.Rollup), position="stack", stat="identity") +
  labs(
    title="Top 5 Cancers by Age",
    x="Age",
    y="Percentage"
  )
```

We can see that cancer has a similar distribution to diabetes and hypertension. However, when we look at the different types of cancers, we can see that ICD Rollups like **Cancer; other primary** have a more even distribution across the ages. Once again we see much higher occurrences for **Cancer of the breast** most likely due to the high population of female HCAs.

### 2.4 Looking into Obesity

Obesity falls under the **Other nutritional; endocrine; and metabolic disorders** ICD Rollup. What is the distribution of HCAs who were diagnosed with obesity?

```{r echo=FALSE} 
obesity_age <- obesity %>% 
  group_by(Age) %>% 
  distinct(Member.ID.Encrypted) %>% 
  summarise(count = n())

obesity_age_percentage <- left_join(obesity_age, age_dist, by= "Age") %>% mutate(percentage = count.x/count.y)

ggplot(obesity_age_percentage) + 
  geom_bar(aes(x=Age, y=percentage), stat="identity", fill="orange") +
  labs(
    title="Obesity by Age",
    x="Age",
    y="Percentage"
  )
```

Unlike the previous chronic diseases, obesity is slightly more evenly distributed. It peaks at several different ages, but more so around ~50 years old; slightly younger than the previous diseases.

Next steps: We will look into the correlation between obesity and other chronic diseases/factors influencing health. It would be interesting to look into whether or not there is any correlation between obesity and income as well.



```{r echo=F}
# Notes

# This person had 13 service lines and showed up 13 times on the table. Therefore, we should use unique memberID/claim ID. However, if the same person has a different claim, it would only show the first one. Therefore, we cannot use unique id.

multiple_claim <- med %>% 
  filter(Claim.ID == "180952D2AB000")

```