---
title: "Analyzing HCA Claims"
author: "Yasmine, Anni, Vanessa, Katie"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(ggplot2)
library(knitr)
library(plotly)

med <- read.csv('../../data/claims_med_interns_2016-2018.csv', stringsAsFactors = F)
#pharm <- read.csv('../../data/claims_pharm_capstone_2016-2018.csv', stringsAsFactors = F)

#med data analysis
med_revise <- med %>% select("Member.ID.Encrypted", "Claim.ID","Member.Gender",
                             "Age","Primary.ICD.Diagnosis.Code","Primary.ICD.Rollup",
                      "X2nd.ICD.Diagnosis.Code","X2nd.ICD.Rollup",
                      "X3rd.ICD.Diagnosis.Code","X3rd.ICD.Rollup",
                      "X4th.ICD.Diagnosis.Code", "X4th.ICD.Rollup", 
                      "Incurred.Year", "CCHG.Label", "Zip..5.digit.") %>% 
  filter(med$Zip..5.digit. < 99403 & med$Zip..5.digit. > 98000)

# get data of chronic diseases
source('get_chronic.R')
```

## 1. What are the most common chronic diseases?

### 1.1 Chronic Diseases of Interest

Our goal is to understand the prevalance and determinants of chronic diseases in Washington State. To do this, we want to first get an understanding of the occurrence of these diseases in the claims data.

The relevant chronic conditions (and their respective ICD-10 codes) we will focus on include:

- Diabetes (excluding gestational diabetes, which has a different ICD-10 code than diabetes mellitus)
- Hypertension (I10)
- Obesity (E66)
- Cancer
- Musculoskeletal conditions (M00-M99)
- Cardiovascular conditions
- Asthma and chronic obstructive pulmonary disorder (COPD)
- Cholesterol (E78)
- Sleep disorders (insomnia ICD-10 is G47)
- Pain (R52 = Pain, unspecified)
- Injury


``` {r echo=FALSE}
chronic <- all %>% 
  group_by(label) %>% 
  distinct(Member.ID.Encrypted) %>% 
  summarize(count=n()) %>% 
  arrange(desc(count))

ggplot(data=chronic, aes(x=reorder(label, count), y=count)) +
  geom_bar(position="dodge",stat="identity", fill = 'red') + 
  coord_flip() +
  labs(title = "Occurrences of Chronic Disease", x = "Chronic Disease")

```

We can observe from this visual that **Cardiovascular** is the most occurring chronic disease by claims, whereas the least occurring disease is **Pain**. We will look into what pain really means in terms of chronic conditions.

*Limitations*

One limitation we observe is the involvement of filtering to distint member ID. We want to do this to avoid accounting for recurring claims for the same ICD for that member, as that may skew the data towards the chronic condition they have. However, having this become distinct leaves out claims a member would file for different reasons. *We need to address this*.

Another limitation is not including the other ICD Rollup codes provided apart from Primary.ICD.Rollup. We also see that if there is no other Rollup involved in that claim, the same Rollup label is sometimes used for X2nd.ICD.Rollup, X3rd, and X4th. We need to account for this so we do not have the same single ICD Rollup code accounted for 4 times for the claim. We plan to address this by

1. Create a column with a list of all ICD Rollups (Primary, X2nd, X3rd, X4th)
2. Narrow lists down to only include *unique* ICD Rollups

Once this is done, we will address the first limitation mentioned above.



### 1.2 What's up with Cardiovascular?

Cardiovascular includes claims with the Primary ICD Rollup of *"Diseases of the Heart."* Cardiovascular has a lot of ICD codes involved, which could attest to its volume shown in the visual above. Let's break it down to see what's really going on!

``` {r echo=FALSE}
cardio_type <- cardiovascular %>% 
  group_by(Primary.ICD.Diagnosis.Code) %>% 
  distinct(Member.ID.Encrypted) %>% 
  summarise(count = n()) %>%
  arrange(-count)

ggplot(data=cardio_type[1:10,], aes(x=reorder(Primary.ICD.Diagnosis.Code, count), y=count)) +
  geom_bar(position="dodge",stat="identity", fill = 'blue') + 
  coord_flip() +
  labs(title = "Most Common Cardiovascular Types", x = "Type of CardioVascular")
```


We actually have **`r nrow(cardio_type)`** ICD codes falling under Cardiovascular chronic disease!

Translations of Codes:

**R079**: Chest pain, unspecified

**R0789**: Other chest pain

**R002**: Palpitations

**I2510**: Atherosclerotic heart disease of native coronary artery without angina pectoris

**I4891**: Unspecified atrial fibrillation

**I480**: Paroxysmal atrial fibrillation

**R072**: Precordial pain

**I214**: Non-ST elevation (NSTEMI) myocardial infarction

**R000**: Tachycardia, unspecified

**I471**: Supraventricular tachycardia



### 1.3 Diving into Cancer

We observe that cancer can be broken down into many different types, and this can be important to address. Now let's look into the occurrences of types of cancer we see in our HCA population.

``` {r echo=FALSE}
cancer_type <- cancer %>% 
  group_by(Primary.ICD.Rollup) %>% 
  distinct(Member.ID.Encrypted) %>% 
  summarise(count = n())

ggplot(data=cancer_type, aes(x=reorder(Primary.ICD.Rollup, count), y=count)) +
  geom_bar(position="dodge",stat="identity", fill = 'pink') + 
  coord_flip() +
  labs(title = "Occurrences of Cancer", x = "Type of Cancer")
```

**Breast cancer** appears to be our most occurring cancer in the HCA population, while **Cancer of male genital organs** appears to be the least occurring. We can perhaps attest this to the gender distribution of our HCA population. Because we have *significantly less males than females*, we are bound to see less occurrence of a cancer associated with males and more associated with women. We can see the gender distribution of our HCA population who have filed at least one claim below.

``` {r echo=FALSE}
gender_df <- med_revise %>% select(Member.ID.Encrypted, Member.Gender) %>%
  distinct(Member.ID.Encrypted, .keep_all = TRUE)

female <- gender_df %>% filter(Member.Gender == 'F')

ggplot(gender_df) + 
  geom_bar(aes(x=Member.Gender, color=Member.Gender, fill = Member.Gender)) +
  labs(title = "Gender Distribution of HCA Population", x = "Gender", y = "Count") +
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)))

```

Of the HCA population that filed claims (*`r nrow(gender_df)`* members), **`r round(nrow(female)/nrow(gender_df), 2) * 100`%** are female and only **`r round((nrow(gender_df) - nrow(female)) / nrow(gender_df), 2) * 100`%** are male.

Next steps: We will continue to research ICD-10 codes to see what may correspond with the chronic diseases of interest. We will also begin to incorporate other ICD Rollups provided along with the Primary ICD Rollups we have included into our visualizations.


## 2. Instances of chronic disease by location

Tableau visualizations of chronic disease by county shown [here](https://public.tableau.com/profile/katie.breland#!/vizhome/Book1dealingwithcounties/ChronicConditionbyCountyDashboard).


```{r echo=FALSE} 

```

## 3. What is the age distribution for chronic disease?

### 3.1 Let's take a look at Diabetes

Diabetes can be broken down into two different ICD Rollups; **Diabetes mellitus with complications* and *Diabetes mellitus without complications**.

```{r echo=FALSE} 
diabetes_age <- diabetes %>% 
  group_by(Age, Primary.ICD.Rollup) %>% 
  distinct(Member.ID.Encrypted) %>% 
  summarise(count = n())

ggplot(diabetes_age) + 
  geom_bar(aes(x=Age, y=count, fill=Primary.ICD.Rollup), position="stack", stat="identity") +
  labs(
    title="Diabetes by Age",
    x="Age",
    y="Count"
  )
```

From the graph above, we can see that both ICD Rollups have similar distributions, with diabetes occuring more often in the older HCA population (~60 years old). However, we have to keep in mind that this distribution is very similar to the overall HCA age distribution.

Next steps: We hope to look into the distributions by different types of diabetes (i.e. Type 1, Type 2). In addition, we will look into the correlation between diabetes and other chronic diseases/factors influencing health of interest.

### 3.2 What about Hypertension?

Hyptension, otherwise known as High Blood Pressure, is a common condition among U.S. adults. Let's look into the age distribution for Hypertension!

```{r echo=FALSE} 
hypertension_age <- hypertension %>% 
  group_by(Age) %>% 
  distinct(Member.ID.Encrypted) %>% 
  summarise(count = n())

ggplot(hypertension_age) + 
  geom_bar(aes(x=Age, y=count), stat="identity", fill="pink") +
  labs(
    title="Hypertension by Age",
    x="Age",
    y="Count"
  )
```

As we can see from the graph above, the distribution for Hypertension is similar to the distribution for Diabetes, but we still have to keep in mind the distribution of our overall HCA population. 

Next steps: We want to look into the correlations between Hypertension and different chronic diseases/factors influencing health. Hypertension increases risk for other diseases and many factors such as diet can contribute to Hypertension, so this would be an interesting area to explore.

### 3.3 What can we see with Cancer?

As we saw earlier, there are many different types of cancer. Let's take a look at the top five types of cancer the HCA population have been diagnosed with.

```{r echo=FALSE} 
top_5_cancer <- cancer_type %>% arrange(desc(count))
top_5_cancer <- top_5_cancer[1:5,]

cancer_age <- cancer %>% 
  group_by(Age, Primary.ICD.Rollup) %>% 
  distinct(Member.ID.Encrypted, Primary.ICD.Rollup) %>% 
  summarise(count = n()) %>% 
  filter(Primary.ICD.Rollup %in% top_5_cancer$Primary.ICD.Rollup)
  

ggplot(cancer_age) + 
  geom_bar(aes(x=Age, y=count, fill=Primary.ICD.Rollup), position="stack", stat="identity") +
  labs(
    title="Top 5 Cancers by Age",
    x="Age",
    y="Count"
  )
```

We can see that cancer has a similar distribution to diabetes and hypertension. However, when we look at the different types of cancers, we can see that ICD Rollups like **Cancer; other primary** have a more even distribution across the ages. Once again we see much higher occurrences for **Cancer of the breast** most likely due to the high population of female HCAs.

### 3.4 Looking into Obesity

Obesity falls under the **Other nutritional; endocrine; and metabolic disorders** ICD Rollup. What is the distribution of HCAs who were diagnosed with obesity?

```{r echo=FALSE} 
obesity_age <- obesity %>% 
  group_by(Age) %>% 
  distinct(Member.ID.Encrypted) %>% 
  summarise(count = n())

ggplot(obesity_age) + 
  geom_bar(aes(x=Age, y=count), stat="identity", fill="orange") +
  labs(
    title="Obesity by Age",
    x="Age",
    y="Count"
  )
```

Unlike the previous chronic diseases, obesity is slightly more evenly distributed. It peaks at several different ages, but more so around ~50 years old; slightly younger than the previous diseases.

Next steps: We will look into the correlation between obesity and other chronic diseases/factors influencing health. It would be interesting to look into whether or not there is any correlation between obesity and income as well.



```{r echo=F}
# Notes

# This person had 13 service lines and showed up 13 times on the table. Therefore, we should use unique memberID/claim ID. However, if the same person has a different claim, it would only show the first one. Therefore, we cannot use unique id.

multiple_claim <- med %>% 
  filter(Claim.ID == "180952D2AB000")

```