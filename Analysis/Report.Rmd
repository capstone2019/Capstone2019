---
title: "High-Level Med Analysis"
author: "Yasmine, Anni, Vanessa, Katie"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
#library(PerformanceAnalytics) #find correlation chart.Correlation()
library(ggplot2)
library(knitr)
library(plotly)

#Read in the data()
med <- read.csv('claims_med_interns_2016-2018.csv', stringsAsFactors = F)
pharm <- read.csv('claims_pharm_capstone_2016-2018.csv', stringsAsFactors = F)

#med data analysis
med_revise <- med %>% select("Member.ID.Encrypted", "Claim.ID","Member.Gender",
                             "Age","Primary.ICD.Diagnosis.Code","Primary.ICD.Rollup",
                      "X2nd.ICD.Diagnosis.Code","X2nd.ICD.Rollup",
                      "X3rd.ICD.Diagnosis.Code","X3rd.ICD.Rollup",
                      "X4th.ICD.Diagnosis.Code", "X4th.ICD.Rollup", 
                      "Incurred.Year", "CCHG.Label", "Zip..5.digit.")

```

## Gender and Age
This graph shows the gender distribution in the current data.The red color in the graph represents the number of female and the blue color represents the number of male workers.

As you can see, __the ratio of female workers to male workers is roughly 7:1__.

```{r, echo=FALSE}
#Gender Distribution
ggplot(med_revise) + 
  geom_bar(aes(x=Member.Gender, color=Member.Gender, fill = Member.Gender)) +
  labs(title = "Gender Distribution", x = "Gender", y = "Count") +
  scale_y_continuous(name="Fluorescent intensity/arbitrary units", labels = scales::comma) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)))
```

The plot below shows the age distribution of the workers by gender. Red represents female workers blue represents the male workeres. The plot shows that __more than 50% of the workers from 2016 - 2018 are between age 50 and 70__. This distribution applies to both female and male workers.

```{r, echo=FALSE, message=FALSE}
#Age Distribution
ggplot(med_revise) + 
  geom_histogram(aes(x=Age, color=Member.Gender), fill="white", stat="count") +
  labs(title = "Age Distribution", x = "Age", y = "Count") +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)))
```

We can display distribution of age over the years 2016-2018. A slight right skew is shown in age.

```{r, echo=FALSE}
#Age Distribution by Year
year_one_data <- med_revise %>% 
  filter(Incurred.Year == 2016) %>%  
  select(Age) %>% 
  group_by(Age) %>% 
  summarise(num = n())

colnames(year_one_data) <- c("2016", "num")

year_two_data <- med_revise %>% 
  filter(Incurred.Year == 2017) %>%  
  select(Age) %>% 
  group_by(Age) %>% 
  summarise(num = n())

colnames(year_two_data) <- c("2017", "num")

year_three_data <- med_revise %>% 
  filter(Incurred.Year == 2018) %>% 
  select(Age) %>% 
  group_by(Age) %>% 
  summarise(num = n())

colnames(year_three_data) <- c("2018", "num")

# ggplot() + 
#   geom_line(data = year_one_data, aes(x = `2016`, y = num), color = "blue") +
#   geom_line(data = year_two_data, aes(x = `2017`, y = num), color = "red") +
#   geom_line(data = year_three_data, aes(x = `2018`, y = num), color = "black") +
#   labs(title = "Age Distribution by Year", x = "Age", y = "Number of Claims")

ggplot(med_revise) + 
  geom_line(aes(x=Age), stat="count") +
  labs(title = "Age Distribution by Year", x = "Age", y = "Count") +
  facet_wrap(~Incurred.Year)
```


## Looking into Chronic Disease

Let's take a look at the 10 most common ICD rollups. We currently only include primary ICD rollups. We aim to include 2nd, 3rd, and 4th rollups if applicable in order to analyze all things happening in the claim.

```{r, echo=FALSE}
# Icd rollup distribution
icd <- med_revise %>% 
  group_by(Primary.ICD.Rollup) %>% 
  distinct(Claim.ID) %>% 
  summarize(count=n()) %>% 
  arrange(desc(count))

ggplot(data=icd[1:10,], aes(x=reorder(Primary.ICD.Rollup, count), y=count)) +
  geom_bar(position="dodge",stat="identity", fill = 'pink') + 
  coord_flip() +
  labs(title = "Most Common ICD", x = "ICD Rollups")

```

We can do the same thing for CCHG. *Active cancer* is the most occurent.

```{r, echo=FALSE}
# Icd rollup distribution
cchg <- med_revise %>% 
  group_by(CCHG.Label) %>% 
  distinct(Claim.ID) %>% 
  summarize(count=n()) %>% 
  arrange(desc(count))

ggplot(data=cchg[1:10,], aes(x=reorder(CCHG.Label, count), y=count)) +
  geom_bar(position="dodge",stat="identity", fill = 'lightblue') + 
  coord_flip() +
  labs(title = "Most Common CCHG", x = "CCHG") +
  scale_x_discrete(
    labels=c("125 - Other chronic conditions","116 - Neurologic disorders","104 - Renal failure - post transplant","108 - Severe heart failure/transplant...","118 - Chronic Musculoskeletal/Osteo...", "113 - Hypertension (Includes stroke...", "137 - Healthy Female (16-40)", "112 - Diabetes without CAD", "138 - Healthy Female (41-64)", "	
103 - Active cancer") 
    ) 

```

## Mapping by zip code

``` {r echo=FALSE}

zips <- med_revise %>%
  group_by(Zip..5.digit.) %>%
  summarise(count = n())

names(zips) <- c("zip", "value")


library(zipcode)

data(zipcode)
zips$zip<- clean.zipcodes(zips$zip)
zips <- left_join(zips, zipcode, by = 'zip')


```

First, an interesting find is that the data does not only include Washington data, as shown below.

``` {r echo=FALSE}
zip_state <- zips%>%
  group_by(state) %>%
  summarise(count = n())

ggplot(data=zip_state, aes(x=reorder(state, count), y=count)) +
  geom_bar(position="dodge",stat="identity", fill = 'light green') + 
  coord_flip() +
  labs(title = "Number of Claims by Sate", x = "State", y = "Count")


```



``` {r echo=FALSE}

# Map the claims!


# g <- list(
#   scope = 'usa',
#   projection = list(type = 'albers usa'),
#   showland = TRUE,
#   landcolor = toRGB("gray85"),
#   subunitwidth = 1,
#   countrywidth = 1,
#   subunitcolor = toRGB("white"),
#   countrycolor = toRGB("white")
# )
# 
# 
# map <- plot_geo(zips, locationmode = 'USA-states', sizes = c(1, 250)) %>%
#   add_markers(
#     x = ~longitude, y = ~latitude, size = ~value, hoverinfo = "text",
#     text = ~paste(zips$city, "<br />", zips$state)
#   ) %>%
#   layout(title = 'Claims', geo = g)
# 
# map


###

# Another try
# needs API Key for ggmap get_map
# library(ggmap)
# get_map("Washington", zoom = 12) %>% ggmap() +
#   geom_point(data = zips, aes(x = longitude, y = latitude), color = 'red', size = 3)

```


## Side Work

```{r, echo=FALSE}
employee_type <- pharm %>% 
  group_by(Employee.Type) %>% 
  distinct(Claim.ID) %>% 
  summarize(n=n()) %>% 
  arrange(desc(n))

ggplot(employee_type) + 
  geom_bar(aes(x=Employee.Type, y=n), stat = "identity") +
  labs(title = "Employee Type Count", x = "Employee Type", y = "Count")
```

```{r, echo=FALSE}
#Chronic disease by gender
med_gender <- med_revise %>% 
  group_by(CCHG.Label, Member.Gender) %>% 
  distinct(Claim.ID) %>% 
  summarize(n=n()) %>% 
  arrange(CCHG.Label)

top_10 <- med_gender %>% arrange(desc(n))
kable(top_10[1:10,])
```

```{r, echo=FALSE}
#Chronic disease by age
med_age <- med_revise %>% 
  group_by(CCHG.Label, Age) %>% 
  distinct(Claim.ID) %>% 
  summarize(n=n()) %>% 
  arrange(CCHG.Label)

top_10 <- med_age %>% arrange(desc(n))
kable(top_10[1:10,])
```

```{r, echo=FALSE}
#Chronic disease by zipcode
med_zip <- med_revise %>% 
  group_by(CCHG.Label, Zip..5.digit.) %>% 
  distinct(Claim.ID) %>% 
  summarize(n=n()) %>% 
  arrange(CCHG.Label)

top_10 <- med_zip %>% arrange(desc(n))
kable(top_10[1:10,])
```

```{r, echo=FALSE}
#plot of 2016 Chronic disease by gender and age
med_analysis_2016 <- med_revise %>% 
  filter(Incurred.Year == 2016) %>% 
  group_by(CCHG.Label, Age, Member.Gender) %>% 
  distinct(Claim.ID) %>% 
  summarize(n=n()) %>% 
  arrange(CCHG.Label) %>% 
  ggplot() +
  geom_point(mapping = aes(x = Age, y = n, color = Member.Gender)) +
  facet_wrap(~CCHG.Label)

med_analysis_2016
```

```{r, echo=FALSE}
#plot of 2017 Chronic disease by gender and age
med_analysis_2017 <- med_revise %>% 
  filter(Incurred.Year == 2017) %>% 
  group_by(CCHG.Label, Age, Member.Gender) %>% 
  distinct(Claim.ID) %>% 
  summarize(n=n()) %>% 
  arrange(CCHG.Label) %>% 
  ggplot() +
  geom_point(mapping = aes(x = Age, y = n, color = Member.Gender)) +
  facet_wrap(~CCHG.Label)
med_analysis_2017
```

```{r, echo=FALSE}
#plot of 2018 Chronic disease by gender and age
med_analysis_2018 <- med_revise %>% 
  filter(Incurred.Year == 2018) %>% 
  group_by(CCHG.Label, Age, Member.Gender) %>% 
  distinct(Claim.ID) %>% 
  summarize(n=n()) %>% 
  arrange(CCHG.Label) %>% 
  ggplot() +
  geom_point(mapping = aes(x = Age, y = n, color = Member.Gender)) +
  facet_wrap(~CCHG.Label)

med_analysis_2018
```

##Primary.ICD.Rollup is factors influcening health
The two graphs below shows the top ten factors influencing healthcare worker's health. THe first graph is by diagnose code and the second one is by cCHG Label. 
```{r, echo=FALSE}

health_factors_by_code <- med_revise %>% 
   filter(Primary.ICD.Rollup == "Factors influencing health care") %>% 
   group_by(Primary.ICD.Diagnosis.Code) %>% 
   distinct(Member.ID.Encrypted) %>% 
   summarize(num = n()) %>%
  arrange(desc(num)) %>% 
  head(10)

kable(health_factors_by_code)

health_factors_by_cchg <- med_revise %>% 
   filter(Primary.ICD.Rollup == "Factors influencing health care") %>% 
   group_by(CCHG.Label) %>% 
   distinct(Member.ID.Encrypted) %>% 
   summarize(num = n()) %>%
  arrange(desc(num)) %>% 
  head(10)

kable(health_factors_by_cchg)

```